'use strict';
function AppCtrl($route, $location, $window, $xhr) {
    $xhr.defaults.headers.post['Content-Type'] = 'application/json';
    $xhr.defaults.headers.put['Content-Type'] = 'application/json';

    var token = $("meta[name='csrf-token']").attr("content");
    $xhr.defaults.headers.post['X-CSRF-Token'] = token;
    $xhr.defaults.headers.put['X-CSRF-Token'] = token;
    $xhr.defaults.headers['delete']['X-CSRF-Token'] = token;

    $route.when('/vaults', {template: '<%= asset_path "vaults.html" %>', controller: VaultsCtrl});

    var self = this;

    $route.onChange(function() {
	if ($location.hash === '') {
	    $location.updateHash('/vaults');
	    self.$eval();
	} else {
	    $route.current.scope.params = $route.current.params;
	    $window.scrollTo(0,0);
	}
    });
}
AppCtrl.$inject = ['$route', '$location', '$window', '$xhr'];

function VaultsCtrl(Blob, Aes) {
    function Card(json) {
	if (json) {
	    this.name = json.name;
	    this.details = json.details;
	    this.expanded = false;
	} else {
	    this.name = "Unnamed";
	    this.expanded = true;
	}
    }
    Card.prototype.deleted = false;
    Card.prototype.toggle = function() {
	this.expanded = !this.expanded;
    }
    Card.prototype.hide = function() {
	this.expanded = false;
    }
    Card.prototype.toSerial = function() {
	var card = {
	    name: this.name,
	    details: this.details
	};
	return card;
    }
    var Vault = function(resource) {
	if (resource) {
	    this.resource = resource;
	} else {
	    this.cards = [];
	    this.locked = false;
	    this.resource = new Blob();
	}
    }
    Vault.prototype.locked = true;
    Vault.prototype.lock = function() {
	this.serialize();
	this.locked = true;
	this.cards = null;
	this.progress(null);
    };
    Vault.prototype.serialize = function() {
	if (this.locked) {
	    return;
	}
	var ptext = angular.toJson(this.cards.filter(function(c) { return !c.deleted }).map(function(c) { return c.toSerial() }));
	this.resource.ctext = Aes.encrypt(this.key, this.iv, ptext);
    }
    Vault.prototype.import = function(data) {
	if (data) {
	    var lines = data.split('\n');
	    for (var i = 0; i < lines.length; i++) {
		var fields = lines[i].split(',');
		if (!fields[0] || fields[0] == "uuid") {
		    continue;
		}
		var name = fields[1] + "/" + fields[2];
		var details = "user: " + fields[4] + "\npass: " + fields[5] + "\nurl: " + fields[3] + "\nnotes:" + fields[6];
		this.cards.push(new Card({ name: name, details: details}));
	    }
	    this.importing = false;
	    data = null;
	} else {
	    this.importing = true;
	}
    };
    Vault.prototype.progress = function (status) {
	this.status = status;
	self.$eval();
    };
    Vault.prototype.remove = function(card) {
	this.cards.splice(this.cards.indexOf(card),1);
    };
    Vault.prototype.setPassword = function(password) {
	this.resource.salt = null;
	this.key = null;
	this.iv = null;
	this.password = password;
	Aes.precompute(password, this);
	this.progress(null);
    }
    Vault.prototype.unlock = function(contents) {
	if (!this.locked) {
	    return;
	}
	if (!contents) {
	    this.progress("Incorrect password, please try again");
	    return;
	}
	this.locked = false;
	this.cards = contents.map(function(c) { return new Card(c); });
	this.resource.ctext = null;
	this.progress(null);
    };
    Vault.prototype.update = function(info) {
	if (!info) {
	    return;
	}
	this.resource.name = info.name;
	this.resource.crypto = info.crypto;
	this.setPassword(info.password);
    };
    var self = this;
    Blob.index(function(r, hdrs) {
	window._loaded = r;
	var mapped = r.map(function(j) { return new Vault(j); });
	window._mapped = mapped;
	self.vaults = mapped;
    });
    self.addCard = function(vault) {
	vault.cards.push(new Card());
    }
    self.save = function(vault) {
	vault.serialize();
	if (vault.resource.id) {
	    vault.resource.$update();
	} else {
	    vault.resource.$create();
	}
    }
    function vaultDetails(name, crypto, isNew) {
	return { name: name || "Untitled",
		 isNew: isNew,
		 crypto: crypto || "aesStandard",
		 cryptos: Aes.versions };
    }
    self.editDetails = function(vault) {
	var updateInfo = showModalDialog("wallets/" + vault.id + "/edit", vaultDetails(vault.resource.name, vault.resource.crypto, false), "dialogwidth: 500; dialogheight: 500; ");
	vault.update(updateInfo);
    }
    self.addVault = function() {
	var vault = new Vault();
	var creationInfo = showModalDialog("wallets/new", vaultDetails("Untitled", null, true), "dialogwidth: 450; dialogheight: 300; ");
	if (creationInfo) {
	    vault.update(creationInfo);
	    self.vaults.push(vault);
	    self.selected = vault;
	}
    }
    self.remove = function(vault) {
	if (confirm("Permanently remove '" + vault.resource.name + "'?")) {
	    self.vaults.splice(self.vaults.indexOf(vault),1);
	    if (vault.resource.id) {
		vault.resource.$delete();
	    }
	}
	if (self.selected == vault) {
	    self.selected = null;
	}
    }
    self.select = function(vault) {
	if (self.selected) {
	    self.selected.selected = false;
	}
	self.selected = vault;
	vault.selected = true;
    }
    self.lock = function(vault) {
	vault.lock();
	self.$eval();
    }
    self.unlock = function(password, vault) {
	Aes.precompute(password, vault, function() {
	    var ptext;
	    if (vault.resource.ctext) {
		ptext = Aes.decrypt(vault.key, vault.iv, vault.resource.ctext);
	    } else {
		ptext = [];
	    }
	    vault.unlock(ptext);
	});
    };
}
VaultsCtrl.$inject = ['Blob', 'Aes'];

function DetailsCtrl() {
    var self = this;
    var args = window.dialogArguments;
    this.name = args.name || "Untitled";
    this.cryptos = args.cryptos;
    this.crypto = args.crypto;
    this.submit = args.isNew ? "Create" : "Save";
    this.password = "";
    this.confirm = "";
    this.cancel = function() {
	window.close();
    }
    this.createVault = function() {
        if (self.password == self.confirm) {
            window.returnValue = { name: self.name,
				   password: self.password,
				   crypto: self.crypto };
            window.close();
        } else {
            alert("Passwords do not match");
        } 
    }
    document.getElementById("vaultName").value = args.name;
    if (args.new) {
        document.getElementById("createButton").value = "Create";
    }
}
DetailsCtrl.$inject = [];
